"use strict";!function(){angular.module("gen",["gen.home","gen.wall","gen.final","ui.router","ngSanitize","ui.bootstrap"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("home")}]).run(["$log","$rootScope","$state",function(a,b,c){b.$on("$stateChangeStart",function(b,c,d){a.debug("state should change to state "+c.name)}),b.$on("$stateChangeSuccess",function(b,c,d,e){a.debug("state change with success from "+e.name+" to state "+c.name)})}])}(),angular.module("gen.car.directives",["gen.car.service","gen.floor.service"]).directive("car",["CarService","FloorService","$interval","$log",function(a,b,c,d){function e(c){var d=new b2World(o,q),e=b.createFloor(r,d);return{world:d,carFilled:a.createCar(c,o,d,p),camera_y:0,camera_x:0,last_drawn_tile:0,floorTiles:e}}function f(a){if(a.world.Step(1/n,20,20),a.carFilled.frames++,a.carFilled.checkDeath())return"stop"}function g(a,b){var c=b.getContext("2d");c.clearRect(0,0,b.width,b.height),c.save(),h(a),c.translate(150-a.camera_x*t,120+a.camera_y*t),c.scale(t,-t),i(a,c),k(a,c),c.restore()}function h(a){var b=a.carFilled.getPosition(),c=a.camera_y-b.y,d=a.camera_x-b.x;a.camera_y-=s*c,a.camera_x-=s*d}function i(a,b){b.strokeStyle="#000",b.fillStyle="#666",b.lineWidth=1/t,b.beginPath();a:for(var c=Math.max(0,a.last_drawn_tile-20);c<a.floorTiles.length;c++)for(var d=a.floorTiles[c],e=d.GetFixtureList();e;e=e.m_next){var f=e.GetShape(),g=d.GetWorldPoint(f.m_vertices[0]).x;if(g>a.camera_x-5&&g<a.camera_x+10&&j(d,f.m_vertices,f.m_vertexCount,b),g>a.camera_x+10){a.last_drawn_tile=c;break a}}b.fill(),b.stroke()}function j(a,b,c,d){var e=a.GetWorldPoint(b[0]);d.moveTo(e.x,e.y);for(var f=1;f<c;f++){var g=a.GetWorldPoint(b[f]);d.lineTo(g.x,g.y)}d.lineTo(e.x,e.y)}function k(a,b){if(a.carFilled.alive){if(!(a.carFilled.getPosition().x<a.camera_x-5)){b.strokeStyle="#444",b.lineWidth=1/t;for(var c=0;c<a.carFilled.wheels.length;c++)for(var d=a.carFilled.wheels[c],e=d.GetFixtureList();e;e=e.m_next){var f=e.GetShape(),g=Math.round(255-255*(e.m_density-v)/u).toString(),h="rgb("+g+","+g+","+g+")";m(d,f.m_p,f.m_radius,d.m_sweep.a,h,b)}var i=Math.round(100-(a.carFilled.car_def.chassis_density-x)/w*70).toString()+"%";b.strokeStyle="#c44";var k=a.carFilled.car_def.team;b.fillStyle=l(k,i),b.beginPath();for(var d=a.carFilled.chassis,e=d.GetFixtureList();e;e=e.m_next){var f=e.GetShape();j(d,f.m_vertices,f.m_vertexCount,b)}b.fill(),b.stroke()}}}function l(a,b){return"BLUE"==a?"hsl(207,90%,"+b+")":"RED"==a?"hsl(4,90%,"+b+")":"GREEN"==a?"hsl(122,39%,"+b+")":"ORANGE"==a?"hsl(36,100%,"+b+")":"YELLOW"==a?"hsl(54,100%,"+b+")":"PURPLE"==a?"hsl(291,64%,"+b+")":"hsl(0,50%,"+b+")"}function m(a,b,c,d,e,f){var g=a.GetWorldPoint(b);f.fillStyle=e,f.beginPath(),f.arc(g.x,g.y,c,0,2*Math.PI,!0),f.moveTo(g.x,g.y),f.lineTo(g.x+c*Math.cos(d),g.y+c*Math.sin(d)),f.fill(),f.stroke()}var n=60,o=new b2Vec2(0,-9.81),p=0,q=!0,r=Math.seedrandom(),s=.05,t=70,u=100,v=40,w=300,x=30;return{restrict:"A",scope:{champion:"=champion"},link:function(b,h){var i=a.createCarDef(b.champion.carScore.car,b.champion.statistic.team),j=e(i),k=c(function(){"stop"===f(j)&&(b.stop=!0)},Math.round(1e3/n)),l=c(function(){g(j,h[0])},Math.round(1e3/60));b.$watch("stop",function(a,b){a&&(d.info("stop received"),c.cancel(k),c.cancel(l))}),h.on("$destroy",function(){c.cancel(k),c.cancel(l),j.carFilled.kill()})}}}]),angular.module("gen.car.service",[]).service("CarService",["$q",function(a){function b(a,b,d){var e=new b2BodyDef;e.type=b2Body.b2_dynamicBody,e.position.Set(0,4);var f=d.CreateBody(e);return c(f,a[0],a[1],b),c(f,a[1],a[2],b),c(f,a[2],a[3],b),c(f,a[3],a[4],b),c(f,a[4],a[5],b),c(f,a[5],a[6],b),c(f,a[6],a[7],b),c(f,a[7],a[0],b),f.vertex_list=a,f}function c(a,b,c,d){var e=[];e.push(b),e.push(c),e.push(b2Vec2.Make(0,0));var f=new b2FixtureDef;f.shape=new b2PolygonShape,f.density=d,f.friction=10,f.restitution=.2,f.filter.groupIndex=-1,f.shape.SetAsArray(e,3),a.CreateFixture(f)}function d(a,b,c){var d=new b2BodyDef;d.type=b2Body.b2_dynamicBody,d.position.Set(0,0);var e=c.CreateBody(d),f=new b2FixtureDef;return f.shape=new b2CircleShape(a),f.density=b,f.friction=1,f.restitution=.2,f.filter.groupIndex=-1,e.CreateFixture(f),e}var e=60,f=10*e,g={};return g.createCarDef=function(a,b){var c={};return c.team=b,c.wheelCount=2,c.wheel_radius=[],c.wheel_density=[],c.wheel_vertex=[],c.wheel_radius[0]=a.wheel1.radius,c.wheel_density[0]=a.wheel1.density,c.wheel_vertex[0]=a.wheel1.vertex,c.wheel_radius[1]=a.wheel2.radius,c.wheel_density[1]=a.wheel2.density,c.wheel_vertex[1]=a.wheel2.vertex,c.chassis_density=a.chassis.densite,c.vertex_list=[],c.vertex_list.push(new b2Vec2(a.chassis.vecteurs[0],0)),c.vertex_list.push(new b2Vec2(a.chassis.vecteurs[2],a.chassis.vecteurs[3])),c.vertex_list.push(new b2Vec2(0,a.chassis.vecteurs[5])),c.vertex_list.push(new b2Vec2(a.chassis.vecteurs[6],a.chassis.vecteurs[7])),c.vertex_list.push(new b2Vec2(a.chassis.vecteurs[8],0)),c.vertex_list.push(new b2Vec2(a.chassis.vecteurs[10],a.chassis.vecteurs[11])),c.vertex_list.push(new b2Vec2(0,a.chassis.vecteurs[13])),c.vertex_list.push(new b2Vec2(a.chassis.vecteurs[14],a.chassis.vecteurs[15])),c},g.resetCar=function(a){a.health=f,a.maxPosition=0,a.maxPositiony=0,a.minPositiony=0,a.frames=0,a.alive=!0},g.createCar=function(a,c,e,g){var h={};h.health=f,h.maxPosition=0,h.maxPositiony=0,h.minPositiony=0,h.frames=0,h.car_def=a,h.alive=!0,h.chassis=b(a.vertex_list,a.chassis_density,e),h.wheels=[];for(var i=0;i<a.wheelCount;i++)h.wheels[i]=d(a.wheel_radius[i],a.wheel_density[i],e);for(var j=h.chassis.GetMass(),i=0;i<a.wheelCount;i++)j+=h.wheels[i].GetMass();for(var k=[],i=0;i<a.wheelCount;i++)k[i]=j*-c.y/a.wheel_radius[i];for(var l=new b2RevoluteJointDef,i=0;i<a.wheelCount;i++){var m=h.chassis.vertex_list[a.wheel_vertex[i]];l.localAnchorA.Set(m.x,m.y),l.localAnchorB.Set(0,0),l.maxMotorTorque=k[i],l.motorSpeed=-g,l.enableMotor=!0,l.bodyA=h.chassis,l.bodyB=h.wheels[i],e.CreateJoint(l)}return h.getPosition=function(){return h.chassis.GetPosition()},h.kill=function(){e.DestroyBody(h.chassis);for(var a=0;a<h.wheels.length;a++)e.DestroyBody(h.wheels[a]);h.alive=!1},h.checkDeath=function(){var a=h.getPosition();if(a.y>h.maxPositiony&&(h.maxPositiony=a.y),a.y<h.minPositiony&&(h.minPositiony=a.y),a.x>h.maxPosition+.02)h.health=f,h.maxPosition=a.x;else if(a.x>h.maxPosition&&(h.maxPosition=a.x),Math.abs(h.chassis.GetLinearVelocity().x)<.001&&(h.health-=5),--h.health<=0)return!0},h},g}]),angular.module("gen.floor.service",[]).service("FloorService",["$q",function(a){function b(a,b,d){var g=new b2BodyDef;g.position.Set(a.x,a.y);var h=d.CreateBody(g),i=new b2FixtureDef;i.shape=new b2PolygonShape,i.friction=.5;var j=[];j.push(new b2Vec2(0,0)),j.push(new b2Vec2(0,-f)),j.push(new b2Vec2(e,-f)),j.push(new b2Vec2(e,0));var k=new b2Vec2(0,0),l=c(j,k,b);return i.shape.SetAsArray(l),h.CreateFixture(i),h}function c(a,b,c){for(var d=[],e=0;e<a.length;e++){var f={};f.x=Math.cos(c)*(a[e].x-b.x)-Math.sin(c)*(a[e].y-b.y)+b.x,f.y=Math.sin(c)*(a[e].x-b.x)+Math.cos(c)*(a[e].y-b.y)+b.y,d.push(f)}return d}var d=200,e=1.5,f=.15,g={};return g.createFloor=function(a,c){var e=null,f=new b2Vec2(-5,0),g=[];Math.seedrandom(a);for(var h=0;h<d;h++){e=b(f,1.5*(3*Math.random()-1.5)*h/d,c),g.push(e);var i=e.GetFixtureList();f=e.GetWorldPoint(i.GetShape().m_vertices[3])}return g},g}]),angular.module("gen.resources",["gen.config","ngResource"]).factory("SimulationResource",["$resource","config",function(a,b){return a(b.SIMULATION_PATH+"/champions/:team",{},{getAllChampions:{method:"GET",isArray:!0},getChampionForTeam:{method:"GET",isArray:!1}})}]),angular.module("gen.config",[]).config(["$provide",function(a){var b=9e3==location.port?"//localhost:8080":"";a.constant("config",{SIMULATION_PATH:b+"/simulation",SWAGGER_PATH:b+"/swagger-ui.html",WALL_SOCKET_URL:b+"/status/champions",WALL_CHAMPIONS_TOPIC:"/topic/champions",Wall_CHAMPIONS_BROKER:"/app/status/champions"})}]),angular.module("gen.final.directives",["gen.car.service","gen.floor.service"]).directive("carTournament",["CarService","FloorService","$interval","$log",function(a,b,c,d){function e(c){var d=new b2World(p,r),e=b.createFloor(s,d),f=[];return c.forEach(function(b){f.push(a.createCar(b,p,d,q))}),{world:d,carFilledList:f,camera_y:0,camera_x:0,cameraTarget_indexCar:-1,last_drawn_tile:0,nbDeadCars:0,leader:{position:{x:0,y:0},index:null},floorTiles:e}}function f(a){if(a.world.Step(1/o,20,20),a.carFilledList.filter(function(a){return a.alive}).forEach(function(b,c){b.frames++,b.checkDeath()&&(b.kill(),a.nbDeadCars++,a.cameraTarget_indexCar==c&&(a.cameraTarget_indexCar=-1))}),a.nbDeadCars==a.carFilledList.length)return"stop";g(a)}function g(a){var b=0;a.carFilledList.filter(function(a){return a.alive}).forEach(function(c,d){var e=c.getPosition();e.x>b&&(b=e.x,a.leader={position:e,index:d})})}function h(a,b){var c=b.getContext("2d");c.clearRect(0,0,b.width,b.height),c.save(),i(a),c.translate(200-a.camera_x*u,200+a.camera_y*u),c.scale(u,-u),j(a,c),l(a,c),c.restore()}function i(a){var b=a.cameraTarget_indexCar>-1?a.carFilledList[a.cameraTarget_indexCar].getPosition():a.leader.position,c=a.camera_y-b.y,d=a.camera_x-b.x;a.camera_y-=t*c,a.camera_x-=t*d}function j(a,b){b.strokeStyle="#000",b.fillStyle="#666",b.lineWidth=1/u,b.beginPath();a:for(var c=Math.max(0,a.last_drawn_tile-20);c<a.floorTiles.length;c++)for(var d=a.floorTiles[c],e=d.GetFixtureList();e;e=e.m_next){var f=e.GetShape(),g=d.GetWorldPoint(f.m_vertices[0]).x;if(g>a.camera_x-5&&g<a.camera_x+15&&k(d,f.m_vertices,f.m_vertexCount,b),g>a.camera_x+15){a.last_drawn_tile=c;break a}}b.fill(),b.stroke()}function k(a,b,c,d){var e=a.GetWorldPoint(b[0]);d.moveTo(e.x,e.y);for(var f=1;f<c;f++){var g=a.GetWorldPoint(b[f]);d.lineTo(g.x,g.y)}d.lineTo(e.x,e.y)}function l(a,b){a.carFilledList.filter(function(a){return a.alive}).forEach(function(c,d){if(c.getPosition().x<a.camera_x-5)return void console.log("too far behind, don't draw");b.strokeStyle="#444",b.lineWidth=1/u;for(var e=0;e<c.wheels.length;e++)for(var f=c.wheels[e],g=f.GetFixtureList();g;g=g.m_next){var h=g.GetShape(),i=Math.round(255-255*(g.m_density-w)/v).toString(),j="rgb("+i+","+i+","+i+")";n(f,h.m_p,h.m_radius,f.m_sweep.a,j,b)}var l=Math.round(100-(c.car_def.chassis_density-y)/x*70).toString()+"%";b.strokeStyle="#c44";var o=c.car_def.team;b.fillStyle=m(o,l),b.beginPath();for(var f=c.chassis,g=f.GetFixtureList();g;g=g.m_next){var h=g.GetShape();k(f,h.m_vertices,h.m_vertexCount,b)}b.fill(),b.stroke()})}function m(a,b){return"BLUE"==a?"hsl(207,90%,"+b+")":"RED"==a?"hsl(4,90%,"+b+")":"GREEN"==a?"hsl(122,39%,"+b+")":"ORANGE"==a?"hsl(36,100%,"+b+")":"YELLOW"==a?"hsl(54,100%,"+b+")":"PURPLE"==a?"hsl(291,64%,"+b+")":"hsl(0,50%,"+b+")"}function n(a,b,c,d,e,f){var g=a.GetWorldPoint(b);f.fillStyle=e,f.beginPath(),f.arc(g.x,g.y,c,0,2*Math.PI,!0),f.moveTo(g.x,g.y),f.lineTo(g.x+c*Math.cos(d),g.y+c*Math.sin(d)),f.fill(),f.stroke()}var o=60,p=new b2Vec2(0,-9.81),q=20,r=!0,s=Math.seedrandom(),t=.05,u=70,v=100,w=40,x=300,y=30;return{restrict:"A",scope:{champions:"=champions"},link:function(b,g){var i=g[0],j={width:i.width,height:i.height},k=[];b.champions.forEach(function(b){k.push(a.createCarDef(b.carScore.car,b.statistic.team))});var l=e(k),m=c(function(){"stop"===f(l)&&(b.stop=!0)},Math.round(1e3/o)),n=c(function(){h(l,i)},Math.round(1e3/60));b.$watch("stop",function(a){a&&(d.info("stop received"),c.cancel(m),c.cancel(n))}),b.$on("fullscreen-final",function(a,b){console.log("event received",a,b),b?(i.width=window.innerWidth,i.height=window.innerHeight):(i.width=j.width,i.height=j.height)}),g.on("$destroy",function(){c.cancel(m),c.cancel(n),l.carFilledList.forEach(function(a){a.kill()})})}}}]),angular.module("gen.final",["ui.router","gen.final.directives","gen.resources"]).config(["$stateProvider",function(a){a.state("final",{url:"/final",templateUrl:"scripts/app/final/final-tpl.html",controller:"FinalController"})}]).controller("FinalController",["$scope","SimulationResource",function(a,b){function c(){b.getAllChampions().$promise.then(function(b){a.champions=b})}function d(){"final"==a.wrapperClass?(a.wrapperClass="final-fullscreen",a.$broadcast("fullscreen-final",!0)):(a.wrapperClass="final",a.$broadcast("fullscreen-final",!1))}c(),a.fullWindow=d,a.wrapperClass="final",angular.element(window).on("resize",function(){"final-fullscreen"==a.wrapperClass&&a.$broadcast("fullscreen-final",!0)})}]),angular.module("gen.home",["ui.router","gen.config"]).config(["$stateProvider",function(a){a.state("home",{url:"/home",templateUrl:"scripts/app/home/home-tpl.html",controller:"HomeController"})}]).controller("HomeController",["$scope","config",function(a,b){a.swaggerPath=b.SWAGGER_PATH}]),angular.module("gen.wall",["ui.router","gen.wall.service","gen.car.directives","gen.resources"]).config(["$stateProvider",function(a){a.state("wall",{url:"/wall",templateUrl:"scripts/app/wall/wall-tpl.html",controller:"WallController"})}]).controller("WallController",["$scope","ChampionsService","SimulationResource",function(a,b,c){function d(){c.getAllChampions().$promise.then(function(b){a.champions=b,a.champions.sort(g)})}function e(){a.champions=[],b.connect(),a.connected=!0}function f(){a.champions=[],b.disconnect(),a.connected=!1}function g(a,b){return b.carScore.score-a.carScore.score}a.connected=!1,a.connect=e,a.disconnect=f,a.retrieveChampions=d,e(),b.receive().then(null,null,function(b){_.remove(a.champions,function(a){return a.statistic.team==b.champion.statistic.team}),a.champions.push(b.champion),a.champions.sort(g)}),a.$on("$destroy",function(){b.disconnect()})}]),angular.module("gen.wall.service",["gen.config"]).service("ChampionsService",["$q","$log","config",function(a,b,c){var d={},e=a.defer(),f={client:null,stomp:null},g=[];d.SOCKET_URL=c.WALL_SOCKET_URL,d.CHAMPIONS_TOPIC=c.WALL_CHAMPIONS_TOPIC,d.CHAMPIONS_BROKER=c.Wall_CHAMPIONS_BROKER;var h=function(a){var b=JSON.parse(a),c={champion:b};return _.some(g,c.id)&&(c.self=!0,g=_.remove(g,c.id)),c},i=function(){f.stomp.subscribe(d.CHAMPIONS_TOPIC,function(a){e.notify(h(a.body))})};return d.receive=function(){return e.promise},d.send=function(a){var b=Math.floor(1e6*Math.random());f.stomp.send(d.CHAMPIONS_BROKER,{priority:9},JSON.stringify({message:a,id:b})),g.push(b)},d.connect=function(){f.client||(f.client=new SockJS(d.SOCKET_URL),f.stomp=Stomp.over(f.client),f.stomp.connect({},i))},d.disconnect=function(){f.stomp&&(f.stomp.disconnect(),f.client=null,f.stomp=null)},d}]);